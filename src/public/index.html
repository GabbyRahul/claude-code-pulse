<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>claude-code-pulse</title>
<script src="chart.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --bg-card: #161b22;
    --bg-hover: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --text-dim: #484f58;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --teal: #39d2c0;
    --pink: #f778ba;
    --radius: 8px;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    --mono: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
  }
  [data-theme="light"] {
    --bg: #ffffff;
    --bg-card: #f6f8fa;
    --bg-hover: #eaeef2;
    --border: #d0d7de;
    --text: #1f2328;
    --text-muted: #656d76;
    --text-dim: #afb8c1;
    --accent: #0969da;
    --green: #1a7f37;
    --orange: #9a6700;
    --red: #cf222e;
    --purple: #8250df;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 16px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header h1 {
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .header h1 span { color: var(--accent); }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 6px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 13px;
    font-family: var(--font);
    transition: background 0.15s, color 0.15s;
  }
  .btn:hover { background: var(--bg-hover); color: var(--text); }
  .btn-stop { color: #f87171; border-color: #f8717155; }
  .btn-stop:hover { background: #f8717122; color: #f87171; }
  .last-updated { color: var(--text-dim); font-size: 12px; }
  .filter-btns { display: flex; gap: 4px; }
  .filter-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 4px 10px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 12px;
    font-family: var(--font);
    transition: background 0.15s, color 0.15s, border-color 0.15s;
  }
  .filter-btn:hover { background: var(--bg-hover); color: var(--text); }
  .filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--bg-hover); }
  .delta { font-size: 11px; margin-top: 2px; }
  .delta.up { color: var(--green); }
  .delta.down { color: var(--red); }
  .delta.flat { color: var(--text-dim); }

  /* Loading */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    flex-direction: column;
    gap: 16px;
  }
  .loading-spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Cards grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 28px;
  }
  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .stat-card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .stat-card .value { font-size: 28px; font-weight: 600; font-family: var(--mono); }
  .stat-card .sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

  /* Section */
  .section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
  }
  .section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Heatmap */
  .heatmap-container { overflow-x: auto; }
  .heatmap-grid {
    display: inline-grid;
    grid-template-rows: repeat(7, 24px);
    grid-auto-flow: column;
    gap: 4px;
  }
  .heatmap-cell {
    width: 24px;
    height: 24px;
    border-radius: 3px;
    background: var(--border);
    cursor: default;
    position: relative;
  }
  .heatmap-cell[data-level="1"] { background: #0e4429; }
  .heatmap-cell[data-level="2"] { background: #006d32; }
  .heatmap-cell[data-level="3"] { background: #26a641; }
  .heatmap-cell[data-level="4"] { background: #39d353; }
  [data-theme="light"] .heatmap-cell[data-level="1"] { background: #9be9a8; }
  [data-theme="light"] .heatmap-cell[data-level="2"] { background: #40c463; }
  [data-theme="light"] .heatmap-cell[data-level="3"] { background: #30a14e; }
  [data-theme="light"] .heatmap-cell[data-level="4"] { background: #216e39; }

  #heatmapTooltip {
    position: fixed;
    z-index: 1000;
    pointer-events: none;
    background: var(--text);
    color: var(--bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .heatmap-labels {
    width: 30px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-right: 8px;
  }
  .heatmap-labels span {
    font-size: 10px;
    color: var(--text-dim);
    height: 24px;
    line-height: 24px;
    text-align: right;
    flex-shrink: 0;
  }
  .heatmap-months {
    margin-top: 6px;
    margin-left: 30px;
    display: flex;
    gap: 0;
    font-size: 10px;
    color: var(--text-dim);
  }
  .heatmap-legend {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-dim);
  }
  .heatmap-legend .heatmap-cell { cursor: default; width: 14px; height: 14px; }

  /* Charts */
  .chart-container { position: relative; height: 250px; }
  .charts-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
  }
  @media (max-width: 768px) {
    .charts-row { grid-template-columns: 1fr; }
  }

  /* Tables */
  .table-container { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text-muted);
    font-weight: 500;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    user-select: none;
  }
  th:hover { color: var(--text); }
  th.sortable { cursor: pointer; user-select: none; }
  .sort-icon { font-size: 10px; color: var(--text-dim); margin-left: 3px; }
  .sort-icon.active { color: var(--accent); }
  td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--bg-hover); }
  .mono { font-family: var(--mono); font-size: 12px; }
  .text-muted { color: var(--text-muted); }
  .text-right { text-align: right; }
  .truncate { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-inline {
    display: inline-block;
    height: 8px;
    border-radius: 4px;
    background: var(--accent);
    margin-right: 8px;
    vertical-align: middle;
  }

  /* Optimizations */
  .opt-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; }
  .opt-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    gap: 12px;
  }
  .opt-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .opt-card[data-impact="high"] .opt-icon { background: rgba(248,81,73,0.15); }
  .opt-card[data-impact="medium"] .opt-icon { background: rgba(210,153,34,0.15); }
  .opt-card[data-impact="low"] .opt-icon { background: rgba(88,166,255,0.15); }
  .opt-card[data-impact="info"] .opt-icon { background: rgba(139,148,158,0.15); }
  .opt-card[data-impact="positive"] .opt-icon { background: rgba(63,185,80,0.15); }
  .opt-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .opt-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .opt-badge {
    display: inline-block;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 10px;
    margin-left: 6px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    vertical-align: middle;
  }
  .opt-badge.high { background: rgba(248,81,73,0.2); color: var(--red); }
  .opt-badge.medium { background: rgba(210,153,34,0.2); color: var(--orange); }
  .opt-badge.low { background: rgba(88,166,255,0.2); color: var(--accent); }

  /* Tool stats */
  .tool-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .tool-name { width: 140px; font-size: 12px; font-family: var(--mono); text-align: right; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tool-bar-track { flex: 1; height: 16px; background: var(--bg); border-radius: 4px; overflow: hidden; }
  .tool-bar-fill { height: 100%; border-radius: 4px; background: var(--purple); transition: width 0.3s; }
  .tool-count { width: 50px; font-size: 12px; font-family: var(--mono); color: var(--text-dim); }

  /* Footer */
  .footer {
    text-align: center;
    padding: 24px 0 12px;
    font-size: 12px;
    color: var(--text-dim);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
  }
  .empty-state h2 { margin-bottom: 8px; }
  .empty-state p { color: var(--text-muted); }

  /* Cost disclaimer */
  .cost-note {
    font-size: 11px;
    color: var(--text-dim);
    font-style: italic;
    margin-top: 2px;
  }

  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
    padding-bottom: -1px;
    overflow-x: auto;
  }
  .tab {
    padding: 8px 14px;
    font-size: 13px;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
    white-space: nowrap;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: var(--font);
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Best & Worst Sessions */
  .best-worst-grid { display: flex; flex-direction: column; gap: 20px; }
  .bw-row { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
  @media (max-width: 700px) { .bw-row { grid-template-columns: 1fr; } }
  .bw-column-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .bw-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-left: 3px solid;
    border-radius: var(--radius);
    padding: 14px;
  }
  .bw-card.best { border-left-color: var(--green); }
  .bw-card.worst { border-left-color: var(--red); }
  .bw-badge { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .bw-badge.best { color: var(--green); }
  .bw-badge.worst { color: var(--red); }
  .bw-prompt { font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bw-meta { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
  .bw-stats { display: flex; flex-wrap: nowrap; gap: 12px; font-size: 11px; font-family: var(--mono); overflow: hidden; }
  .bw-stat { display: flex; gap: 4px; align-items: baseline; white-space: nowrap; }
  .bw-stat .val { color: var(--text); font-weight: 600; }
  .bw-stat .lbl { color: var(--text-dim); }
  .bw-reason { font-size: 11px; color: var(--text-muted); margin-top: 8px; font-style: italic; }
  .bw-card { transition: background 0.15s, box-shadow 0.15s; }
  .bw-card:hover { background: var(--bg-hover); box-shadow: 0 0 0 1px var(--border); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; width:min(680px,95vw); max-height:85vh; overflow-y:auto; padding:28px; position:relative; transform:translateY(20px); transition:transform 0.2s; }
  .modal-overlay.open .modal { transform:translateY(0); }
  .modal-close { position:absolute; top:14px; right:16px; background:none; border:none; color:var(--text-muted); font-size:20px; cursor:pointer; line-height:1; padding:4px 8px; border-radius:4px; }
  .modal-close:hover { color:var(--text); background:var(--bg-hover); }
  .modal-title { font-size:15px; font-weight:600; padding-right:40px; line-height:1.4; margin-bottom:6px; }
  .modal-subtitle { font-size:12px; color:var(--text-muted); font-family:var(--mono); margin-bottom:14px; }
  .modal-chips { display:flex; flex-wrap:wrap; gap:8px; margin:14px 0; }
  .modal-chip { background:var(--bg); border:1px solid var(--border); border-radius:20px; padding:4px 12px; font-size:12px; font-family:var(--mono); }
  .modal-chip .chip-label { color:var(--text-dim); margin-right:4px; }
  .modal-section-title { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-dim); margin-bottom:8px; }
  .token-bar { display:flex; height:10px; border-radius:5px; overflow:hidden; margin:10px 0 6px; }
  .token-bar-labels { display:flex; gap:14px; flex-wrap:wrap; margin-bottom:16px; }
  .token-bar-label { font-size:11px; font-family:var(--mono); display:flex; align-items:center; gap:4px; color:var(--text-muted); }
  .token-bar-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .modal-insights { list-style:none; display:flex; flex-direction:column; gap:6px; margin-top:4px; }
  .modal-insights li { font-size:13px; color:var(--text-muted); padding:10px 14px; background:var(--bg); border-radius:var(--radius); border-left:3px solid var(--border); }
  .modal-rank-banner { padding:8px 14px; border-radius:var(--radius); font-size:13px; font-weight:600; margin-bottom:16px; }
  .modal-rank-banner.best { background:rgba(63,185,80,0.1); color:var(--green); border:1px solid rgba(63,185,80,0.3); }
  .modal-rank-banner.worst { background:rgba(248,81,73,0.1); color:var(--red); border:1px solid rgba(248,81,73,0.3); }
</style>
</head>
<body>
<div id="heatmapTooltip"></div>
<div class="container">
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div style="color: var(--text-muted); font-size: 14px;">Analyzing your Claude Code sessions...</div>
  </div>
  <div id="app" style="display:none;">
    <!-- Header -->
    <div class="header">
      <h1><span>claude</span>-pulse</h1>
      <div class="header-actions">
        <span class="last-updated" id="lastUpdated"></span>
        <div class="filter-btns" id="filterBtns">
          <button class="filter-btn" data-range="7d">7D</button>
          <button class="filter-btn" data-range="30d">30D</button>
          <button class="filter-btn" data-range="90d">90D</button>
          <button class="filter-btn active" data-range="all">All</button>
        </div>
        <button class="btn" id="refreshBtn" aria-label="Refresh data">Refresh</button>
        <button class="btn" id="themeBtn" aria-label="Toggle theme">Light</button>
        <button class="btn btn-stop" id="stopBtn" aria-label="Stop server">Stop</button>
      </div>
    </div>

    <!-- Summary cards -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
      <button class="tab" data-tab="projects" role="tab">Projects</button>
      <button class="tab" data-tab="sessions" role="tab">Sessions</button>
      <button class="tab" data-tab="tools" role="tab">Tools</button>
      <button class="tab" data-tab="prompts" role="tab">Prompts</button>
      <button class="tab" data-tab="optimize" role="tab">Optimize</button>
    </div>

    <!-- Overview tab -->
    <div class="tab-content active" id="tab-overview">
      <div class="charts-row">
        <div class="section">
          <div class="section-title">Usage Heatmap (last 12 weeks)</div>
          <div class="heatmap-container" id="heatmapContainer"></div>
        </div>
        <div class="section">
          <div class="section-title">Usage by Hour of Day</div>
          <div class="chart-container"><canvas id="hourChart"></canvas></div>
        </div>
      </div>
      <div class="charts-row">
        <div class="section">
          <div class="section-title">Daily Token Usage</div>
          <div class="chart-container"><canvas id="dailyChart"></canvas></div>
        </div>
        <div class="section">
          <div class="section-title">Model Breakdown</div>
          <div class="chart-container"><canvas id="modelChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Projects tab -->
    <div class="tab-content" id="tab-projects">
      <div class="section">
        <div class="section-title">Projects by Token Usage</div>
        <div class="table-container" id="projectsTable"></div>
      </div>
    </div>

    <!-- Sessions tab -->
    <div class="tab-content" id="tab-sessions">
      <div class="section">
        <div class="section-title">Best &amp; Worst Sessions</div>
        <div class="best-worst-grid" id="bestWorstGrid"></div>
      </div>
      <div class="section">
        <div class="section-title">All Sessions (sorted by tokens)</div>
        <div class="table-container" id="sessionsTable"></div>
      </div>
    </div>

    <!-- Tools tab -->
    <div class="tab-content" id="tab-tools">
      <div class="section">
        <div class="section-title">Tool Usage Frequency</div>
        <div id="toolsChart"></div>
      </div>
    </div>

    <!-- Prompts tab -->
    <div class="tab-content" id="tab-prompts">
      <div class="section">
        <div class="section-title">Top Token-Heavy Prompts</div>
        <div class="table-container" id="promptsTable"></div>
      </div>
    </div>

    <!-- Optimize tab -->
    <div class="tab-content" id="tab-optimize">
      <div class="section">
        <div class="section-title">Token Optimization Suggestions</div>
        <div class="opt-grid" id="optimizations"></div>
      </div>
    </div>

    <div class="footer">
      All data stays on your machine. claude-code-pulse reads ~/.claude/ locally.
    </div>
  </div>
</div>

<noscript>
  <div style="text-align:center;padding:60px;color:#e6edf3;font-family:sans-serif;">
    <h2>JavaScript Required</h2>
    <p>claude-code-pulse needs JavaScript to render the dashboard.</p>
  </div>
</noscript>

<div class="modal-overlay" id="sessionModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal" id="modalBox">
    <button class="modal-close" id="modalClose" aria-label="Close">✕</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// Theme
const themeBtn = $('#themeBtn');
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  themeBtn.textContent = t === 'dark' ? 'Light' : 'Dark';
  localStorage.setItem('claude-code-pulse-theme', t);
}
themeBtn.addEventListener('click', () => {
  setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
  if (window._data) renderAll(getFilteredData(window._data));
});
const savedTheme = localStorage.getItem('claude-code-pulse-theme') || 'dark';
setTheme(savedTheme);

// Tabs
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
    $$('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    tab.setAttribute('aria-selected', 'true');
    $(`#tab-${tab.dataset.tab}`).classList.add('active');
  });
});

// Formatting
function fmt(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toLocaleString();
}
function fmtCost(n) { return '~$' + n.toFixed(2); }
function fmtPct(n) { return (n * 100).toFixed(0) + '%'; }
function escapeHtml(s) {
  const el = document.createElement('span');
  el.textContent = s;
  return el.innerHTML;
}
function shortModel(m) {
  return m.replace('claude-', '').replace(/-\d{8}$/, '');
}
function shortProject(p) {
  const parts = p.replace(/^-/, '/').replace(/-/g, '/').split('/');
  return parts.slice(-2).join('/') || p;
}

let sessionSort = { col: 'tokens', dir: 'desc' };
let promptSort = { col: 'tokens', dir: 'desc' };
let dateFilter = 'all';

// Date range filter
function getCutoff(range) {
  if (range === 'all') return null;
  const d = new Date();
  const days = range === '7d' ? 7 : range === '30d' ? 30 : 90;
  d.setDate(d.getDate() - (days - 1));
  return d.toISOString().split('T')[0];
}

function getFilteredData(data) {
  const cutoff = getCutoff(dateFilter);
  if (!cutoff) return data;

  const sessions = data.sessions.filter(s => s.date >= cutoff);
  const dailyUsage = data.dailyUsage.filter(d => d.date >= cutoff);
  const topPrompts = (data.topPrompts || []).filter(p => p.date >= cutoff);

  // Recompute totals
  const totalInput = sessions.reduce((s, x) => s + x.inputTokens, 0);
  const totalOutput = sessions.reduce((s, x) => s + x.outputTokens, 0);
  const totalCacheCreation = sessions.reduce((s, x) => s + x.cacheCreationTokens, 0);
  const totalCacheRead = sessions.reduce((s, x) => s + x.cacheReadTokens, 0);
  const totalTokens = totalInput + totalOutput + totalCacheCreation + totalCacheRead;
  const totalCost = sessions.reduce((s, x) => s + x.cost, 0);
  const totalQueries = sessions.reduce((s, x) => s + x.queryCount, 0);
  const totalThinkingTurns = sessions.reduce((s, x) => s + x.thinkingTurns, 0);
  const cacheHitRate = (totalCacheRead + totalCacheCreation) > 0
    ? totalCacheRead / (totalCacheRead + totalCacheCreation + totalInput) : 0;

  // Recompute projects
  const projectMap = {};
  for (const s of sessions) {
    if (!projectMap[s.project]) projectMap[s.project] = { project: s.project, inputTokens: 0, outputTokens: 0, cacheCreationTokens: 0, cacheReadTokens: 0, totalTokens: 0, cost: 0, sessionCount: 0, queryCount: 0 };
    const p = projectMap[s.project];
    p.inputTokens += s.inputTokens; p.outputTokens += s.outputTokens;
    p.cacheCreationTokens += s.cacheCreationTokens; p.cacheReadTokens += s.cacheReadTokens;
    p.totalTokens += s.totalTokens; p.cost += s.cost;
    p.sessionCount += 1; p.queryCount += s.queryCount;
  }
  const projects = Object.values(projectMap).sort((a, b) => b.totalTokens - a.totalTokens);

  // Recompute model breakdown
  const modelMap = {};
  for (const s of sessions) {
    if (!modelMap[s.model]) modelMap[s.model] = { model: s.model, totalTokens: 0, inputTokens: 0, outputTokens: 0, cacheCreationTokens: 0, cacheReadTokens: 0, cost: 0, queryCount: 0 };
    const m = modelMap[s.model];
    m.totalTokens += s.totalTokens; m.inputTokens += s.inputTokens;
    m.outputTokens += s.outputTokens; m.cacheCreationTokens += s.cacheCreationTokens;
    m.cacheReadTokens += s.cacheReadTokens; m.cost += s.cost; m.queryCount += s.queryCount;
  }
  const modelBreakdown = Object.values(modelMap).sort((a, b) => b.totalTokens - a.totalTokens);

  return {
    ...data,
    sessions,
    dailyUsage,
    topPrompts,
    projects,
    modelBreakdown,
    totals: {
      totalTokens, totalInput, totalOutput, totalCacheCreation, totalCacheRead,
      totalCost, totalSessions: sessions.length, totalQueries,
      totalThinkingTurns, cacheHitRate,
      avgTokensPerSession: sessions.length > 0 ? Math.round(totalTokens / sessions.length) : 0,
      avgTokensPerQuery: totalQueries > 0 ? Math.round(totalTokens / totalQueries) : 0,
    },
  };
}

// Wire filter buttons
document.getElementById('filterBtns').addEventListener('click', e => {
  const btn = e.target.closest('[data-range]');
  if (!btn || !window._data) return;
  dateFilter = btn.dataset.range;
  $$('#filterBtns [data-range]').forEach(b => b.classList.toggle('active', b === btn));
  renderAll(getFilteredData(window._data));
});

function renderAll(data) {
  renderStats(data);
  renderHeatmap(data);
  renderCharts(data);
  renderHourChart(data);
  renderProjects(data);
  renderBestWorst(data);
  renderSessions(data);
  renderTools(data);
  renderTopPrompts(data);
  renderOptimizations(data);
}

// Fetch data
async function loadData(refresh = false) {
  const url = '/api/usage' + (refresh ? '?refresh=true' : '');
  const res = await fetch(url);
  return res.json();
}

// Render
async function render(refresh = false) {
  try {
    const data = await loadData(refresh);
    window._data = data;
    $('#loading').style.display = 'none';
    $('#app').style.display = 'block';

    if (data.totals.totalSessions === 0) {
      $('#app').innerHTML = `
        <div class="header"><h1><span>claude</span>-pulse</h1></div>
        <div class="empty-state">
          <h2>No sessions found</h2>
          <p>claude-code-pulse reads from ~/.claude/projects/. Start using Claude Code and your usage will appear here.</p>
        </div>`;
      return;
    }

    $('#lastUpdated').textContent = 'Updated ' + new Date().toLocaleTimeString();
    renderAll(getFilteredData(data));
  } catch (err) {
    $('#loading').innerHTML = `<div style="color:var(--red);">Failed to load data: ${escapeHtml(err.message)}</div>`;
  }
}

function weekDelta(dailyUsage, field) {
  const today = new Date();
  const pad = (d) => d.toISOString().split('T')[0];
  const d7 = new Date(today); d7.setDate(today.getDate() - 6);
  const d14 = new Date(today); d14.setDate(today.getDate() - 13);
  const d8 = new Date(today); d8.setDate(today.getDate() - 7);
  const thisWeek = dailyUsage.filter(d => d.date >= pad(d7)).reduce((s, d) => s + (d[field] || 0), 0);
  const lastWeek = dailyUsage.filter(d => d.date >= pad(d14) && d.date < pad(d8)).reduce((s, d) => s + (d[field] || 0), 0);
  if (lastWeek === 0) return null;
  return ((thisWeek - lastWeek) / lastWeek) * 100;
}

function deltaHtml(pct) {
  if (pct === null) return '';
  if (Math.abs(pct) < 1) return `<div class="delta flat">— no change vs last week</div>`;
  const dir = pct > 0 ? 'up' : 'down';
  const arrow = pct > 0 ? '↑' : '↓';
  return `<div class="delta ${dir}">${arrow} ${Math.abs(pct).toFixed(0)}% vs last week</div>`;
}

function renderStats(data) {
  const t = data.totals;
  const tokenDelta = weekDelta((window._data || data).dailyUsage, 'totalTokens');
  const sessionDelta = weekDelta((window._data || data).dailyUsage, 'sessions');
  const cards = [
    { label: 'Total Tokens', value: fmt(t.totalTokens), sub: `${fmt(t.totalInput)} input + ${fmt(t.totalCacheCreation + t.totalCacheRead)} cached + ${fmt(t.totalOutput)} output`, delta: deltaHtml(tokenDelta) },
    { label: 'Sessions', value: t.totalSessions, sub: `${t.totalQueries} total turns`, delta: deltaHtml(sessionDelta) },
    { label: 'Cache Hit Rate', value: fmtPct(t.cacheHitRate), sub: `${fmt(t.totalCacheRead)} tokens served from cache`, delta: '' },
    { label: 'Avg Tokens / Session', value: fmt(t.avgTokensPerSession), sub: `${fmt(t.avgTokensPerQuery)} per turn`, delta: '' },
  ];
  $('#statsGrid').innerHTML = cards.map(c => `
    <div class="stat-card">
      <div class="label">${c.label}</div>
      <div class="value">${c.value}</div>
      <div class="sub">${c.sub}</div>
      ${c.delta}
    </div>
  `).join('');
}

function renderHeatmap(data) {
  const dailyMap = {};
  for (const d of data.dailyUsage) dailyMap[d.date] = d.totalTokens;

  // Last 12 weeks
  const today = new Date();
  const days = [];
  for (let i = 83; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    days.push({ date: key, tokens: dailyMap[key] || 0, dayOfWeek: d.getDay() });
  }

  const maxTokens = Math.max(...days.map(d => d.tokens), 1);
  function level(tokens) {
    if (tokens === 0) return 0;
    const pct = tokens / maxTokens;
    if (pct < 0.25) return 1;
    if (pct < 0.5) return 2;
    if (pct < 0.75) return 3;
    return 4;
  }

  const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // Pad to start on Monday (Mon=0 … Sun=6)
  const firstDay = (days[0].dayOfWeek + 6) % 7;
  const padded = Array(firstDay).fill(null).concat(days);

  // Build columns (each column = 7 cells = one week)
  const cols = [];
  for (let c = 0; c < Math.ceil(padded.length / 7); c++) {
    cols.push(padded.slice(c * 7, c * 7 + 7));
  }

  // Build month label row — show month name at first col of each new month
  let prevMonth = -1;
  let monthHtml = '';
  for (const col of cols) {
    const firstReal = col.find(d => d !== null);
    const month = firstReal ? new Date(firstReal.date).getUTCMonth() : -1;
    if (firstReal && month !== prevMonth) {
      monthHtml += `<span style="display:inline-block;width:28px;overflow:visible;font-size:10px;color:var(--text-dim);line-height:16px;">${monthNames[month]}</span>`;
      prevMonth = month;
    } else {
      monthHtml += `<span style="display:inline-block;width:28px;"></span>`;
    }
  }

  let html = '<div style="display:flex;align-items:flex-start;">';
  // Left: day-label spacer (30px) + labels
  html += '<div class="heatmap-labels">';
  html += '<div style="height:16px;flex-shrink:0;"></div>';
  for (let i = 0; i < 7; i++) {
    html += `<span>${dayLabels[i]}</span>`;
  }
  html += '</div>';
  // Right: month labels row stacked above grid
  html += '<div style="display:flex;flex-direction:column;">';
  html += `<div style="display:flex;margin-bottom:4px;">${monthHtml}</div>`;
  html += '<div class="heatmap-grid">';
  for (const d of padded) {
    if (!d) {
      html += '<div style="width:24px;height:24px;"></div>';
    } else {
      const [y, m, day] = d.date.split('-');
      const fmtDate = `${day}-${m}-${y}`;
      html += `<div class="heatmap-cell" data-level="${level(d.tokens)}" data-tip="${fmtDate}: ${fmt(d.tokens)} tokens"></div>`;
    }
  }
  html += '</div>';
  html += '</div>';
  html += '</div>';

  // Legend
  html += `<div class="heatmap-legend">
    <span>Less</span>
    <div class="heatmap-cell" data-level="0"></div>
    <div class="heatmap-cell" data-level="1"></div>
    <div class="heatmap-cell" data-level="2"></div>
    <div class="heatmap-cell" data-level="3"></div>
    <div class="heatmap-cell" data-level="4"></div>
    <span>More</span>
  </div>`;

  const container = $('#heatmapContainer');
  container.innerHTML = html;
}

let dailyChartInstance = null;
let modelChartInstance = null;

function renderCharts(data) {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const gridColor = isDark ? 'rgba(48,54,61,0.5)' : 'rgba(208,215,222,0.5)';
  const textColor = isDark ? '#8b949e' : '#656d76';

  // Daily chart
  if (dailyChartInstance) dailyChartInstance.destroy();
  const last30 = data.dailyUsage.slice(-30);
  dailyChartInstance = new Chart($('#dailyChart'), {
    type: 'bar',
    data: {
      labels: last30.map(d => d.date.slice(5)),
      datasets: [
        { label: 'Input', data: last30.map(d => d.inputTokens), backgroundColor: isDark ? '#58a6ff' : '#0969da', stack: 's' },
        { label: 'Cache', data: last30.map(d => d.cacheCreationTokens + d.cacheReadTokens), backgroundColor: isDark ? '#bc8cff' : '#8250df', stack: 's' },
        { label: 'Output', data: last30.map(d => d.outputTokens), backgroundColor: isDark ? '#39d2c0' : '#1a7f37', stack: 's' },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: textColor, boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${fmt(ctx.raw)}`,
          },
        },
      },
      scales: {
        x: { ticks: { color: textColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { display: false } },
        y: { stacked: true, ticks: { color: textColor, callback: v => fmt(v) }, grid: { color: gridColor } },
      },
    },
  });

  // Model chart
  if (modelChartInstance) modelChartInstance.destroy();
  const colors = [isDark ? '#58a6ff' : '#0969da', isDark ? '#bc8cff' : '#8250df', isDark ? '#39d2c0' : '#1a7f37', isDark ? '#d29922' : '#9a6700', isDark ? '#f778ba' : '#cf222e'];
  modelChartInstance = new Chart($('#modelChart'), {
    type: 'doughnut',
    data: {
      labels: data.modelBreakdown.map(m => shortModel(m.model)),
      datasets: [{
        data: data.modelBreakdown.map(m => m.totalTokens),
        backgroundColor: colors.slice(0, data.modelBreakdown.length),
        borderWidth: 0,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { color: textColor, padding: 12, boxWidth: 12 } },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: ${fmt(ctx.raw)} tokens (${fmtPct(ctx.raw / data.totals.totalTokens)})`,
          },
        },
      },
    },
  });
}

function renderProjects(data) {
  if (data.projects.length === 0) {
    $('#projectsTable').innerHTML = '<p class="text-muted">No project data</p>';
    return;
  }
  const maxTokens = data.projects[0].totalTokens || 1;
  let html = `<table>
    <thead><tr><th>Project</th><th>Tokens</th><th class="text-right">Sessions</th><th class="text-right">Turns</th><th class="text-right">API-Equiv Cost</th></tr></thead>
    <tbody>`;
  for (const p of data.projects) {
    const barWidth = Math.max(2, (p.totalTokens / maxTokens) * 100);
    html += `<tr>
      <td><div class="bar-inline" style="width:${barWidth}%"></div>${escapeHtml(shortProject(p.project))}</td>
      <td class="mono">${fmt(p.totalTokens)}</td>
      <td class="mono text-right">${p.sessionCount}</td>
      <td class="mono text-right">${p.queryCount}</td>
      <td class="mono text-right text-muted cost-note">${fmtCost(p.cost)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  html += '<div class="cost-note" style="margin-top:8px;">API-equivalent cost shown for reference only. Not your actual subscription cost.</div>';
  $('#projectsTable').innerHTML = html;
}

function scoreSession(s) {
  if (s.totalTokens === 0) return 0;
  const efficiency = s.outputTokens / s.totalTokens;
  const cacheRatio = s.cacheReadTokens / s.totalTokens;
  const toolPenalty = s.toolDensity;
  return (efficiency * 0.5) + (cacheRatio * 0.3) - (toolPenalty * 0.05);
}

function sessionReason(s, isBest) {
  const outputPct = s.totalTokens > 0 ? (s.outputTokens / s.totalTokens * 100).toFixed(0) : 0;
  const cachePct = s.totalTokens > 0 ? (s.cacheReadTokens / s.totalTokens * 100).toFixed(0) : 0;
  const density = s.toolDensity.toFixed(1);

  if (isBest) {
    if (cachePct > 60) return `${cachePct}% cache reuse — minimal re-reading, low overhead`;
    if (outputPct > 20) return `${outputPct}% output ratio — Claude produced a lot per token spent`;
    return `Balanced token use with ${density} tools/turn average`;
  } else {
    if (outputPct < 3) return `Only ${outputPct}% output ratio — mostly re-reading files`;
    if (s.toolDensity > 5) return `${density} tools/turn average — lots of retries or exploration`;
    if (cachePct < 10) return `${cachePct}% cache reuse — context rebuilt repeatedly`;
    return `Low efficiency score across output, cache, and tool usage`;
  }
}

let hourChartInstance = null;

function renderHourChart(data) {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#8b949e' : '#656d76';
  const gridColor = isDark ? 'rgba(48,54,61,0.5)' : 'rgba(208,215,222,0.5)';

  const hourBuckets = new Array(24).fill(0);
  for (const s of data.sessions) {
    if (!s.timestamp) continue;
    const h = new Date(s.timestamp).getHours();
    hourBuckets[h] += s.totalTokens;
  }

  const labels = Array.from({ length: 24 }, (_, i) => `${i}h`);
  const ctx = document.getElementById('hourChart').getContext('2d');
  if (hourChartInstance) { hourChartInstance.destroy(); hourChartInstance = null; }
  hourChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Tokens', data: hourBuckets, backgroundColor: '#58a6ff', borderRadius: 3 }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmt(ctx.raw) + ' tokens' } } },
      scales: {
        x: { ticks: { color: textColor, font: { size: 11 } }, grid: { color: gridColor } },
        y: { ticks: { color: textColor, font: { size: 11 }, callback: v => fmt(v) }, grid: { color: gridColor } },
      },
    },
  });
}

function renderTopPrompts(data) {
  const prompts = [...(data.topPrompts || [])];
  if (prompts.length === 0) {
    $('#promptsTable').innerHTML = '<p class="text-muted">No prompt data available yet.</p>';
    return;
  }

  const { col: pc, dir: pd } = promptSort;
  prompts.sort((a, b) => {
    if (pc === 'date')   { return pd === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date); }
    if (pc === 'tokens') { return pd === 'asc' ? a.totalTokens - b.totalTokens : b.totalTokens - a.totalTokens; }
    if (pc === 'cost')   { return pd === 'asc' ? a.cost - b.cost : b.cost - a.cost; }
    return 0;
  });

  function pSortIcon(c) {
    if (c !== pc) return `<span class="sort-icon">↕</span>`;
    return `<span class="sort-icon active">${pd === 'asc' ? '↑' : '↓'}</span>`;
  }

  let html = `<table>
    <thead><tr>
      <th>Prompt</th>
      <th class="sortable" data-col="date">Date ${pSortIcon('date')}</th>
      <th>Model</th>
      <th class="sortable text-right" data-col="tokens">Tokens ${pSortIcon('tokens')}</th>
      <th class="sortable text-right" data-col="cost">Cost ${pSortIcon('cost')}</th>
    </tr></thead>
    <tbody>`;
  for (const p of prompts) {
    html += `<tr style="cursor:pointer" data-session-id="${escapeHtml(p.sessionId)}">
      <td class="truncate" title="${escapeHtml(p.prompt)}">${escapeHtml(p.prompt)}</td>
      <td class="mono text-muted">${p.date}</td>
      <td class="mono text-muted">${escapeHtml(shortModel(p.model))}</td>
      <td class="mono text-right">${fmt(p.totalTokens)}</td>
      <td class="mono text-right">${fmtCost(p.cost)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  html += `<div class="text-muted" style="margin-top:8px;font-size:12px;">${prompts.length} prompts — click to view session</div>`;

  const container = $('#promptsTable');
  container.innerHTML = html;

  container.querySelector('tbody').addEventListener('click', e => {
    const row = e.target.closest('tr[data-session-id]');
    if (row) openSessionModal(row.dataset.sessionId);
  });

  container.querySelector('thead').addEventListener('click', e => {
    const th = e.target.closest('th[data-col]');
    if (!th) return;
    const c = th.dataset.col;
    if (promptSort.col === c) {
      promptSort.dir = promptSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
      promptSort.col = c;
      promptSort.dir = 'desc';
    }
    renderTopPrompts(getFilteredData(window._data));
  });
}

function renderBestWorst(data) {
  const eligible = data.sessions.filter(s => s.queryCount >= 3);
  if (eligible.length < 2) {
    $('#bestWorstGrid').innerHTML = '<p class="text-muted" style="grid-column:1/-1">Not enough sessions yet (need at least 2 with 3+ turns).</p>';
    return;
  }

  const scored = eligible.map(s => ({ ...s, score: scoreSession(s) }));
  scored.sort((a, b) => b.score - a.score);

  const best = scored.slice(0, 3);
  const worst = scored.slice(-3).reverse();

  function card(s, type, rank) {
    const outputPct = s.totalTokens > 0 ? (s.outputTokens / s.totalTokens * 100).toFixed(0) : 0;
    const cachePct = s.totalTokens > 0 ? (s.cacheReadTokens / s.totalTokens * 100).toFixed(0) : 0;
    const isBest = type === 'best';
    return `<div class="bw-card ${type}" style="cursor:pointer" tabindex="0" role="button"
        data-session-id="${escapeHtml(s.sessionId)}">
      <div class="bw-badge ${type}">${isBest ? '★' : '✕'} ${type === 'best' ? 'Best' : 'Worst'} #${rank}</div>
      <div class="bw-prompt" title="${escapeHtml(s.firstPrompt)}">${escapeHtml(s.firstPrompt)}</div>
      <div class="bw-meta">${s.date} · ${escapeHtml(shortModel(s.model))} · ${fmt(s.totalTokens)} tokens</div>
      <div class="bw-stats">
        <div class="bw-stat"><span class="val">${outputPct}%</span><span class="lbl">output</span></div>
        <div class="bw-stat"><span class="val">${cachePct}%</span><span class="lbl">cache</span></div>
        <div class="bw-stat"><span class="val">${s.toolDensity.toFixed(1)}</span><span class="lbl">tools/turn</span></div>
        <div class="bw-stat"><span class="val">${s.queryCount}</span><span class="lbl">turns</span></div>
      </div>
      <div class="bw-reason">${escapeHtml(sessionReason(s, isBest))}</div>
    </div>`;
  }

  let html = `<div>
    <div class="bw-column-title" style="color:var(--green)">Most Efficient</div>
    <div class="bw-row">${best.map((s, i) => card(s, 'best', i + 1)).join('')}</div>
  </div>
  <div>
    <div class="bw-column-title" style="color:var(--red)">Least Efficient</div>
    <div class="bw-row">${worst.map((s, i) => card(s, 'worst', i + 1)).join('')}</div>
  </div>`;

  const grid = $('#bestWorstGrid');
  grid.innerHTML = html;

  grid.addEventListener('click', e => {
    const card = e.target.closest('[data-session-id]');
    if (card) openSessionModal(card.dataset.sessionId);
  });
  grid.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      const card = e.target.closest('[data-session-id]');
      if (card) openSessionModal(card.dataset.sessionId);
    }
  });
}

function renderSessions(data) {
  const sessions = [...(data.sessions || [])];
  const { col, dir } = sessionSort;
  sessions.sort((a, b) => {
    let av, bv;
    if (col === 'date')       { av = a.date; bv = b.date; return dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av); }
    if (col === 'tokens')     { av = a.totalTokens; bv = b.totalTokens; }
    if (col === 'turns')      { av = a.queryCount;  bv = b.queryCount;  }
    if (col === 'efficiency') { av = a.queryCount >= 3 ? scoreSession(a) : -Infinity; bv = b.queryCount >= 3 ? scoreSession(b) : -Infinity; }
    return dir === 'asc' ? av - bv : bv - av;
  });
  const top50 = sessions.slice(0, 50);

  function sortIcon(c) {
    if (c !== col) return `<span class="sort-icon">↕</span>`;
    return `<span class="sort-icon active">${dir === 'asc' ? '↑' : '↓'}</span>`;
  }

  const effTitle = 'Efficiency score: output ratio × 0.5 + cache ratio × 0.3 − tool density × 0.05';

  let html = `<table>
    <thead><tr>
      <th>Prompt</th>
      <th class="sortable" data-col="date">Date ${sortIcon('date')}</th>
      <th>Model</th>
      <th class="sortable text-right" data-col="tokens">Tokens ${sortIcon('tokens')}</th>
      <th class="sortable text-right" data-col="turns">Turns ${sortIcon('turns')}</th>
      <th class="sortable text-right" data-col="efficiency" title="${effTitle}">Efficiency ${sortIcon('efficiency')}</th>
    </tr></thead>
    <tbody>`;
  for (const s of top50) {
    let effCell;
    if (s.queryCount < 3) {
      effCell = `<td class="mono text-right text-muted" title="Need 3+ turns for score">—</td>`;
    } else {
      const score = scoreSession(s);
      const color = score >= 0.5 ? 'var(--green)' : score >= 0.25 ? 'var(--orange)' : 'var(--red)';
      effCell = `<td class="mono text-right" style="color:${color}" title="${effTitle}">${score.toFixed(2)}</td>`;
    }
    html += `<tr style="cursor:pointer" data-session-id="${escapeHtml(s.sessionId)}">
      <td class="truncate" title="${escapeHtml(s.firstPrompt)}">${escapeHtml(s.firstPrompt)}</td>
      <td class="mono text-muted">${s.date}</td>
      <td class="mono text-muted">${escapeHtml(shortModel(s.model))}</td>
      <td class="mono text-right">${fmt(s.totalTokens)}</td>
      <td class="mono text-right">${s.queryCount}</td>
      ${effCell}
    </tr>`;
  }
  html += '</tbody></table>';
  if (data.sessions.length > 50) {
    html += `<div class="text-muted" style="margin-top:8px;font-size:12px;">Showing top 50 of ${data.sessions.length} sessions by ${col}</div>`;
  }
  const container = $('#sessionsTable');
  container.innerHTML = html;

  container.querySelector('tbody').addEventListener('click', e => {
    const row = e.target.closest('tr[data-session-id]');
    if (row) openSessionModal(row.dataset.sessionId);
  });

  // Sort header click handler
  container.querySelector('thead').addEventListener('click', e => {
    const th = e.target.closest('th[data-col]');
    if (!th) return;
    const c = th.dataset.col;
    if (sessionSort.col === c) {
      sessionSort.dir = sessionSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
      sessionSort.col = c;
      sessionSort.dir = 'desc';
    }
    renderSessions(getFilteredData(window._data));
  });
}

function renderTools(data) {
  if (!data.toolStats || data.toolStats.length === 0) {
    $('#toolsChart').innerHTML = '<p class="text-muted">No tool usage data</p>';
    return;
  }
  const top20 = data.toolStats.slice(0, 20);
  const maxCount = top20[0].count;
  let html = '';
  for (const t of top20) {
    const pct = (t.count / maxCount) * 100;
    html += `<div class="tool-bar-row">
      <div class="tool-name" title="${escapeHtml(t.name)}">${escapeHtml(t.name)}</div>
      <div class="tool-bar-track"><div class="tool-bar-fill" style="width:${pct}%"></div></div>
      <div class="tool-count">${fmt(t.count)}</div>
    </div>`;
  }
  if (data.toolStats.length > 20) {
    html += `<div class="text-muted" style="margin-top:8px;font-size:12px;">Showing top 20 of ${data.toolStats.length} tools</div>`;
  }
  $('#toolsChart').innerHTML = html;
}

function renderOptimizations(data) {
  const opts = data.optimizations || [];
  if (opts.length === 0) {
    $('#optimizations').innerHTML = '<p class="text-muted">Not enough data for optimization suggestions yet. Keep using Claude Code!</p>';
    return;
  }
  const icons = {
    cache: '\u{1F4BE}', session: '\u{1F504}', tool: '\u{1F527}', think: '\u{1F9E0}',
    model: '\u{2728}', project: '\u{1F4C1}', input: '\u{1F4DD}', spike: '\u{1F4C8}', check: '\u2705',
  };
  let html = '';
  for (const opt of opts) {
    const badge = opt.impact === 'positive' || opt.impact === 'info' ? '' :
      `<span class="opt-badge ${opt.impact}">${opt.impact}</span>`;
    html += `<div class="opt-card" data-impact="${opt.impact}">
      <div class="opt-icon">${icons[opt.icon] || '\u{1F4A1}'}</div>
      <div>
        <div class="opt-title">${escapeHtml(opt.title)}${badge}</div>
        <div class="opt-desc">${escapeHtml(opt.description)}</div>
      </div>
    </div>`;
  }
  $('#optimizations').innerHTML = html;
}

// Heatmap tooltip — wired up once to avoid listener accumulation on re-render
(function initHeatmapTooltip() {
  const container = $('#heatmapContainer');
  const tip = document.getElementById('heatmapTooltip');
  container.addEventListener('mouseover', e => {
    const cell = e.target.closest('[data-tip]');
    if (!cell) { tip.style.opacity = '0'; return; }
    tip.textContent = cell.dataset.tip;
    tip.style.opacity = '1';
  });
  container.addEventListener('mousemove', e => {
    tip.style.left = (e.clientX + 14) + 'px';
    tip.style.top = (e.clientY - 36) + 'px';
  });
  container.addEventListener('mouseleave', () => {
    tip.style.opacity = '0';
  });
})();

// Heartbeat — tells server the tab is still open; server shuts down 5 min after last heartbeat
(function startHeartbeat() {
  function beat() { fetch('/api/heartbeat', { method: 'POST' }).catch(() => {}); }
  beat();
  setInterval(beat, 30 * 1000);
})();

// Refresh
$('#refreshBtn').addEventListener('click', () => render(true));

// Stop server
$('#stopBtn').addEventListener('click', async () => {
  if (!confirm('Stop the claude-code-pulse server?')) return;
  const btn = $('#stopBtn');
  btn.textContent = 'Stopping…';
  btn.disabled = true;
  try {
    await fetch('/api/shutdown', { method: 'POST' });
  } catch (_) {}
  document.body.innerHTML = '<div style="padding:2rem;font-family:monospace;">Server stopped. You can close this tab.</div>';
  window.close();
});

// Init
// ── Session Modal ────────────────────────────────────────────────────────────

function decodeProject(p) {
  // Leading '-' means root '/'; then '-' separates path segments
  if (!p) return p;
  return p.replace(/^-/, '/').replace(/-/g, '/');
}

function openSessionModal(sessionId, rankInfo) {
  const s = (window._data.sessions || []).find(x => x.sessionId === sessionId);
  if (!s) return;

  const total = s.totalTokens || 1;
  const outputPct = (s.outputTokens / total * 100).toFixed(1);
  const cachePct  = (s.cacheReadTokens / total * 100).toFixed(1);
  const inputPct  = (s.inputTokens / total * 100).toFixed(1);
  const createPct = (s.cacheCreationTokens / total * 100).toFixed(1);

  // Token bar widths
  const iW = Math.max(0, s.inputTokens / total * 100);
  const cW = Math.max(0, s.cacheCreationTokens / total * 100);
  const rW = Math.max(0, s.cacheReadTokens / total * 100);
  const oW = Math.max(0, s.outputTokens / total * 100);

  // Insights
  const insights = [];
  const cacheHit = s.totalTokens > 0 ? s.cacheReadTokens / s.totalTokens : 0;
  if (cacheHit > 0.7) insights.push(`${(cacheHit*100).toFixed(0)}% of tokens were served from cache — excellent context reuse`);
  else if (cacheHit > 0.3) insights.push(`${(cacheHit*100).toFixed(0)}% cache hit rate — decent reuse, more /compact could help`);
  else insights.push('Low cache reuse — starting fresh each turn. Longer sessions save tokens');

  const outRatio = s.totalTokens > 0 ? s.outputTokens / s.totalTokens : 0;
  if (outRatio < 0.05) insights.push(`Only ${outputPct}% output ratio — Claude spent most tokens reading context, not writing`);
  else if (outRatio > 0.4) insights.push(`${outputPct}% output ratio — Claude wrote a lot this session`);

  if (s.thinkingTurns > 0) insights.push(`Extended thinking used in ${s.thinkingTurns} of ${s.queryCount} turns`);
  insights.push(`${s.totalToolCalls} tool calls across ${s.queryCount} turns (${s.toolDensity.toFixed(1)}/turn avg)`);
  if (s.cost > 0) insights.push(`~$${s.cost.toFixed(4)} API-equivalent cost (not your subscription cost)`);

  // Rank banner
  let rankBanner = '';
  if (rankInfo) {
    const label = rankInfo.type === 'best'
      ? `★ Ranked #${rankInfo.rank} most efficient session`
      : `✕ Ranked #${rankInfo.rank} least efficient session`;
    rankBanner = `<div class="modal-rank-banner ${rankInfo.type}">${label}</div>`;
  }

  const projectDecoded = decodeProject(s.project);

  document.getElementById('modalContent').innerHTML = `
    ${rankBanner}
    <div class="modal-title" id="modalTitle">${escapeHtml(s.firstPrompt)}</div>
    <div class="modal-subtitle">${escapeHtml(projectDecoded)} &nbsp;·&nbsp; ${s.date} &nbsp;·&nbsp; ${escapeHtml(shortModel(s.model))}</div>

    <div class="modal-chips">
      <div class="modal-chip"><span class="chip-label">Total</span>${fmt(s.totalTokens)} tokens</div>
      <div class="modal-chip"><span class="chip-label">Output ratio</span>${outputPct}%</div>
      <div class="modal-chip"><span class="chip-label">Cache reuse</span>${cachePct}%</div>
      <div class="modal-chip"><span class="chip-label">Tools/turn</span>${s.toolDensity.toFixed(1)}</div>
    </div>

    <div class="modal-section-title">Token breakdown</div>
    <div class="token-bar">
      <div class="token-bar-seg" style="width:${iW}%;background:#58a6ff"></div>
      <div class="token-bar-seg" style="width:${cW}%;background:#bc8cff"></div>
      <div class="token-bar-seg" style="width:${rW}%;background:#6e48a0"></div>
      <div class="token-bar-seg" style="width:${oW}%;background:#39d2c0"></div>
    </div>
    <div class="token-bar-labels">
      <span class="token-bar-label"><span class="token-bar-dot" style="background:#58a6ff"></span>Input ${fmt(s.inputTokens)} (${inputPct}%)</span>
      <span class="token-bar-label"><span class="token-bar-dot" style="background:#bc8cff"></span>Cache write ${fmt(s.cacheCreationTokens)} (${createPct}%)</span>
      <span class="token-bar-label"><span class="token-bar-dot" style="background:#6e48a0"></span>Cache read ${fmt(s.cacheReadTokens)} (${cachePct}%)</span>
      <span class="token-bar-label"><span class="token-bar-dot" style="background:#39d2c0"></span>Output ${fmt(s.outputTokens)} (${outputPct}%)</span>
    </div>

    <div class="modal-section-title">Session insights</div>
    <ul class="modal-insights">${insights.map(i => `<li>${escapeHtml(i)}</li>`).join('')}</ul>
  `;

  document.getElementById('sessionModal').classList.add('open');
}

function closeModal() {
  document.getElementById('sessionModal').classList.remove('open');
}

document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('sessionModal').addEventListener('click', e => {
  if (!document.getElementById('modalBox').contains(e.target)) closeModal();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ─────────────────────────────────────────────────────────────────────────────

render();
</script>
</body>
</html>
